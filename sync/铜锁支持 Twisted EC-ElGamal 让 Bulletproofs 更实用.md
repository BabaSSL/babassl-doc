<a name="nZHlM"></a>
## 背景
Bulletproofs 是一种零知识证明系统，用于证明某个陈述是正确的，而不泄露任何有关陈述的信息。在 Bulletproofs 中，其中一个限制是范围大小必须是2的幂次方。这个限制是由 Bulletproofs 算法的设计决定的，具体原因涉及到算法内部的结构和工作原理，详见：[https://www.yuque.com/tsdoc/ts/bulletproofs](https://www.yuque.com/tsdoc/ts/bulletproofs)。Bulletproofs 使用了类似于置换多项式的技术，而这些多项式的次数通常与范围大小相关联。当范围大小是2的幂次方时，可以使用二进制分解等技术更有效地表示和处理这些范围。这有助于提高算法的效率和性能。而如果不限制范围大小为2的幂次方，可能需要引入更多的复杂性和计算开销。<br />具体来说，Bulletproofs 允许证明一个值在给定范围![](https://cdn.nlark.com/yuque/__latex/24afe0ee9a79bbfb19cc3faf409d0887.svg#card=math&code=%20%5B0%2C%202%5En%20-%201%5D%20&id=mDkKo)内，其中 n 是一个非负整数，而且需要满足![](https://cdn.nlark.com/yuque/__latex/cd40280cdc832013a593b2df92ed2275.svg#card=math&code=log_2n&id=SbgOm)有整数解，也就是说 n 也需要是2的幂次方，即 n 只能取 1、2、4、8、16……等等的数，所以 Bulletproofs 能证明的范围粒度就很粗，无法满足于多变的业务场景，比如范围![](https://cdn.nlark.com/yuque/__latex/418743b47249fd7bea503e6b83ddf7a3.svg#card=math&code=%5B8%2C2%5E5-1%5D&id=MPKaH)就无法证明。而 Twisted EC-ElGamal 的算法特性可以与 Bulletproofs 算法结合，让 Bulletproofs 能证明的范围是![](https://cdn.nlark.com/yuque/__latex/636714249aad63086a3792836e976c75.svg#card=math&code=%5B2%5Ei%2C%202%5Ej%5D&id=qAoF2)，其中![](https://cdn.nlark.com/yuque/__latex/5d324c8ab77654e93a513ca71afd5187.svg#card=math&code=0%3Ci%3Cj%20%3C%20n&id=B0UeE)，证明的范围粒度更小更实用。
<a name="lq7MX"></a>
## 原理
Bulletproofs 的 Pedersen 提交公式为： ![](https://cdn.nlark.com/yuque/__latex/2388b3789835aedacd389ca5fa9f3567.svg#card=math&code=V%3Dg%5Erh%5Em&id=mfYCS)，其中 r 为随机数，m 为明文，Pedersen 提交结果为点 V。<br />而 EC-ElGamal 的加密公式为：![](https://cdn.nlark.com/yuque/__latex/94bf3aa33dc208e1133461bc982502f9.svg#card=math&code=C%3D%28g%5Er%2C%20g%5Empk%5Er%29%3D%28C_1%2CC_2%29&id=rWQpJ)，其中 pk 为公钥，r 为随机数，m 为明文，加密结果为C，![](https://cdn.nlark.com/yuque/__latex/3484a0fb89180e2a2896a7689346ed75.svg#card=math&code=C_1&id=aVyHu)和![](https://cdn.nlark.com/yuque/__latex/23c4cd950cf3916a8a78af54b2decd2d.svg#card=math&code=C_2&id=q1H7K)为椭圆曲线上的两个点。<br />将上述公式拆分来看，ElGamal 和 Bulletproofs 是有一些关联的，如下图：<br />![](https://cdn.nlark.com/yuque/0/2023/jpeg/26770235/1703673758476-948c6a83-f37e-4962-bd0d-b3d5e216729f.jpeg)<br />式子比较相似，本质上都是用了半同态加密算法的一些特性来对明文数据加密后进行的运算，山东大学网络空间安全学院陈宇教授发明了 Twisted-ElGamal 算法，该算法兼容 ElGamal 且安全和性能相当的情况下，其输出结果可以当 Bulletproofs 的输入（Pedersen 提交），对 Bulletproofs 更友好，同时可以利用半同态加密的特性来对 Pedersen 提交的结果进行运算，让 Bulletproofs 支持更细粒度的范围证明，原理如下图：<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/26770235/1703675188571-288328ed-07e8-42f7-a96e-32ab774af465.png#averageHue=%23f6f5f5&clientId=ud0b7c724-d18f-4&from=paste&height=690&id=u809c6a9a&originHeight=1380&originWidth=2464&originalType=binary&ratio=2&rotation=0&showTitle=false&size=227783&status=done&style=none&taskId=u356e1452-e76c-4ade-b228-94734953ec3&title=&width=1232)<br />（图片来自陈宇教授的论文截图）<br />通过上述 ![](https://cdn.nlark.com/yuque/__latex/61ee3d340fef1850d69757325080074a.svg#card=math&code=g%5Er&id=gcIq9)和![](https://cdn.nlark.com/yuque/__latex/9c3df2d0f14af08a21a6d3197c1c3c57.svg#card=math&code=pk%5Er&id=E3eTj) 扭曲交换后，依然能保证 ElGamal 的安全和性能。那如何做到更细粒度的范围证明呢？<br />![](https://cdn.nlark.com/yuque/0/2023/jpeg/26770235/1703678011857-8760ad80-eeca-4548-860f-dee642b22a68.jpeg)<br />上图所示，有四个范围：![](https://cdn.nlark.com/yuque/__latex/494fd7bd57f5b8365f06baf179b37b28.svg#card=math&code=%20%5B0%2C%202%5Ei%29%20&id=GsJUH)、![](https://cdn.nlark.com/yuque/__latex/2f202a397e7bf741e34e050d5ffba117.svg#card=math&code=%20%5B2%5Ei%2C%202%5Ej%29&id=tIEIg)、![](https://cdn.nlark.com/yuque/__latex/f832fe4a913137e33df8705ddbb780c3.svg#card=math&code=%20%5B2%5Ej%2C%202%5En%29&id=eCNg2)和![](https://cdn.nlark.com/yuque/__latex/2dee0f980ddf5b18b9361b507e70b353.svg#card=math&code=%20%5B0%2C%202%5En%29&id=HLxbr)，其中![](https://cdn.nlark.com/yuque/__latex/5d324c8ab77654e93a513ca71afd5187.svg#card=math&code=0%3Ci%3Cj%20%3C%20n&id=QEamX)，x1 在![](https://cdn.nlark.com/yuque/__latex/6b58bcf0f8df3db620e5f656ec19d5e1.svg#card=math&code=%20%5B0%2C%202%5Ei%29&id=geBng)、x2 在![](https://cdn.nlark.com/yuque/__latex/28520dbdbfd8fee6399f8561ce90a214.svg#card=math&code=%20%5B2%5Ei%2C%202%5Ej%5D&id=hXeBL)、x3 在![](https://cdn.nlark.com/yuque/__latex/75ccd70a451159a661ab01e7289cf829.svg#card=math&code=%20%282%5Ej%2C%202%5En%29&id=PUPYJ)，Bulletproofs 可证明的范围是 ![](https://cdn.nlark.com/yuque/__latex/24afe0ee9a79bbfb19cc3faf409d0887.svg#card=math&code=%20%5B0%2C%202%5En%20-%201%5D%20&id=APka9)，现证明 x 是否在范围 ![](https://cdn.nlark.com/yuque/__latex/64592ae4a4425dc0f2549eaae8f2486a.svg#card=math&code=%20%5B2%5Ei%2C%202%5Ej%5D%20&id=OL5so)中，那 x 的取值可能为 x1、x2、x3，下面分别证明一下：

1. 当 x 为 x1 时（即 x 在 ![](https://cdn.nlark.com/yuque/__latex/29dd80278cfd3a3c9c5164b67a9700b0.svg#card=math&code=2%5Ei&id=iyYpC)在左边时）
   1. ![](https://cdn.nlark.com/yuque/__latex/a981b93f858b9b2db346a569a0f5bf28.svg#card=math&code=x1-2%5Ei%20%3C%200&id=csCfZ)，不在 Bulletproofs 可证明的范围中，验证失败，说明 x1 即 x 不在 ![](https://cdn.nlark.com/yuque/__latex/28520dbdbfd8fee6399f8561ce90a214.svg#card=math&code=%20%5B2%5Ei%2C%202%5Ej%5D&id=EkUEp)范围中；
2. 当 x 为 x2 时（即 x 在 ![](https://cdn.nlark.com/yuque/__latex/29dd80278cfd3a3c9c5164b67a9700b0.svg#card=math&code=2%5Ei&id=tGbVB)和 ![](https://cdn.nlark.com/yuque/__latex/8a02dafd78fead8fb2a97bd659435abf.svg#card=math&code=2%5Ej&id=rjBlX)之间时）
   1. ![](https://cdn.nlark.com/yuque/__latex/146207e197580e6908937defa56db238.svg#card=math&code=x2-2%5Ei%20%5Cge%200&id=rqCmY)，在 Bulletproofs 可证明的范围中，需进一步验证
   2. ![](https://cdn.nlark.com/yuque/__latex/2a2c6abcecb1cfdcc80786891f4c7868.svg#card=math&code=2%5Ej-x2%20%5Cge%200&id=p94oZ)，在 Bulletproofs 可证明的范围中，说明 x2 即 x 在 ![](https://cdn.nlark.com/yuque/__latex/28520dbdbfd8fee6399f8561ce90a214.svg#card=math&code=%20%5B2%5Ei%2C%202%5Ej%5D&id=rf5KV)范围中；
3. 当 x 为 x3 时（即 x 在 ![](https://cdn.nlark.com/yuque/__latex/8a02dafd78fead8fb2a97bd659435abf.svg#card=math&code=2%5Ej&id=QlRCZ)在右边时）
   1. ![](https://cdn.nlark.com/yuque/__latex/d68063d5da6721e0fb81245922ec6552.svg#card=math&code=x3-2%5Ei%20%3E%200&id=K1o7Q)，在 Bulletproofs 可证明的范围中，需进一步验证
   2. ![](https://cdn.nlark.com/yuque/__latex/ed99780d061baf8cd5b1f77613939ddb.svg#card=math&code=2%5Ej-x3%20%3C%200&id=GW404)，不在 Bulletproofs 可证明的范围中，验证失败，说明 x3 即 x 不在 ![](https://cdn.nlark.com/yuque/__latex/28520dbdbfd8fee6399f8561ce90a214.svg#card=math&code=%20%5B2%5Ei%2C%202%5Ej%5D&id=wrxIn)范围中；

可以看出，只需要验证 ![](https://cdn.nlark.com/yuque/__latex/9b5bbbbf4cf94c7d6501ca9822be9ee9.svg#card=math&code=x-2%5Ei&id=pgV5Q)和 ![](https://cdn.nlark.com/yuque/__latex/367a60fd8db43333690b17828dc061a5.svg#card=math&code=2%5Ej-x&id=WKD7g)是否都在 Bulletproofs 可证明的范围即可。<br />这是明文的加减运算，比较好理解，而 Twisted-ElGamal 是半同态加密算法，其密文加减解密结果和明文加减结果具有一致性，所以 x 在 Bulletproofs 系统中进行 Pedersen 提交后得到的密文可以使用 Twisted-ElGamal 算法来进行密态运算，使用上面相同的证明原理即可将 Bulletproofs 粗粒度的范围进行细化，大大提升 Bulletproofs 的实用性。另外也可以用来证明一个 Twisted-ElGamal 加密的数据是否在某个特定的范围，这在机密交易和安全机器学习等隐私保护应用中非常有用。<br />更详细的原理请查阅陈宇教授的论文：[https://pdfs.semanticscholar.org/de6b/2e11feaa28addb12fa4bfa72cf2a619cb03b.pdf](https://pdfs.semanticscholar.org/de6b/2e11feaa28addb12fa4bfa72cf2a619cb03b.pdf)<br />对代码实现有兴趣请查阅铜锁 zkp 算法的实现：[https://github.com/Tongsuo-Project/Tongsuo/tree/master/crypto/zkp](https://github.com/Tongsuo-Project/Tongsuo/tree/master/crypto/zkp)

